
# Replication of the experiments
## Requirements
The experiments are conducted using python 3.6. The required packages are listed in the requirements.txt file. 



## Data

#### 0. Please follow [README.md](../feature%20extraction/README.md) in the feature extraction folder to prepare the necessary data files.

#### 1. Download the Medical-Diff-VQA dataset from [Physionet](https://physionet.org/content/medical-diff-vqa/1.0.0/) and place all files into the ./data directory.
```
./data/mimic_all.csv
./data/all_diseases.json
./data/mimic_pair_questions.csv
```

#### 2. Ensure the following file exists. This file contains the corresponding relationships between dicom id and the study id in the MIMIC-CXR dataset. This file can be generated by running the get_study2dicom() function in the [mimic_utils.py](utils/mimic_utils.py) file.
```
./data/study2dicom.pkl
```
#### 3. Execute:
```angular2html
python dataset_preparation.py -t -c
```
This will produce the files listed below. The top three files are the ground truth answers in the coco format used for evaluation. The hdf5 file contains the questions and answers in a format that the model can use directly. The last two files are the vocabulary file and the split files. These two files have been provided in the ./data folder. If you use the provided dataset, the generated files should be the same.
```
./data/mimic_gt_captions_test.json
./data/mimic_gt_captions_val.json
./data/mimic_gt_captions_train.json
./data/VQA_mimic_dataset.h5
./data/vocab_mimic_VQA.json
./data/splits_mimic_VQA.json
```



#### 4. Execute the feature extraction code. The feature file below will automatically be placed into the ./data folder. Please refer to the README.md in the [../feature extraction](../feature extraction) folder for more details.
```
./data/cmb_bbox_di_feats.hdf5
```

## Training
```
python train_mimic.py --graph all --use_wandb False --eval_target test
```
--graph: all, implicit, spatial, semantic

--use_wandb: True, False. (wandb is a tool for tracking the training process. If you don't want to use it, set it to False.)

--eval_target: val, test. (choose the set for evaluation during the training. val is for the validation set, test is for the test set)


## Testing
Testing has been integrated in the training code, but it can also be performed separately.

1. Download the provided checkpoint file using this [link](https://drive.google.com/file/d/1gmGOm-MsVKgpLxwFVXqIHN5DnAccmtei/view?usp=sharing), or load your own checkpoint file.

2. run the testing code and specify the path of the checkpoint file.
```angular2html
python test_mimic.py -p <path_to_checkpoint_file> 
```





## (optional) Retrieve the history score 
The evaluation score for each checkpoint can be retrieved by executing the following code.
```angular2html
python evaluate_score.py -n <run_name> -c <checkpoint_num>
```
run_name: the name of the training run. (can be found at the beginning of the training.)

checkpoint_num: the iteration number of the checkpoint. (This should be multiple of the interval. the default interval is 2000)


# User interface application
The user interface application is implemented using PyQt5. Given the large size of the necessary data files, the user interface is constructed under a server-client architecture. Please execute the server file on the server machine where all the data and model files are housed. Afterward, run the client file on the local machine with a display device. If your server machine has a GUI, the client file can also be run on the server machine.

Note: To ensure successful communication between the server and the client, please make sure the server and the client are on the same local network.

https://github.com/Holipori/EKAID/assets/43333502/4519d08a-8048-4ba4-b197-03d62728900d

## Requirements
- PyQt5 

## Run the user interface application
Run the code below on the server machine. As for <mimic_cxr_png>, please refer to [../feature extraction](../feature extraction) for more details.
```angular2html
python visualizations/demo_server.py -c <path_to_checkpoint_file> -p <path_to_mimic_cxr_png>
```

Then, run the code below on the client machine
```angular2html
cd visualizations
python demo_client.py
```
### Instructions
1. enter the IP address of the server machine and click connect.
2. enter the question in the question box and click send.
3. the answer will be displayed in the text box below.
4. ask another question or click 'refresh' to switch to another pair of images.



